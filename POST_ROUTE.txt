  // POST /api/posts - Create a new post with optional media upload
  app.post("/api/posts", upload.single('media'), async (req, res) => {
    try {
      if (!req.user) {
        return res.status(401).send("Not authenticated");
      }

      const { title, content, category } = req.body;
      
      if (!content || !category) {
        return res.status(400).send("Content and category are required");
      }

      // Build post object
      const postData: any = {
        authorId: req.user.id,
        content,
        category
      };

      // Add title if it exists (for media posts)
      if (title) {
        postData.title = title;
      }

      // Handle media upload
      if (req.file) {
        postData.mediaUrl = req.file.filename;
        postData.mediaType = req.body.mediaType || (req.file.mimetype.startsWith('image/') ? 'image' : 'video');
      }

      const post = await storage.createPost(postData);
      res.status(201).json(post);
    } catch (error) {
      console.error('Error creating post:', error);
      res.status(500).send("Failed to create post");
    }
  });
